#Make file of RJG routines to deal with mds+
#Modifications:
#5/8/00:   Created by rjg
#2/15/01:  Revised by rjg to add more routines
#2/26/01:  Revised by rjg to add mtanh_ts stuff
#11/02/03: Revised by rjg to remove old switches
#07/21/14: Revised by tbt for Linux64
#08/25/14: Revised by tbt for pgf90 13.2 on venus. 64-bits
#09/19/14: Revised by tbt to change mpif90 from 32-bit to 64-bit
#09/19/14: Revised by tbt to add -Msave to zero out variables.
#2016.04.01 M.Kostuk adding support for MdsPlus lib64

# the f90 sources
F90_SRCS =  mdslib.f90 \
            mds_rg.f90 \
            mds_mtanh_rdts.f90 \
            mds_mtanh.f90
#F90_SRCS = mds_rg.f90 \
#           mds_mtanh.f90 \
#           mds_mtanh_rdts.f90 \
#           mds_write_rg.f90  
##           mds_interface.f90
##           mds_getcer.f90   

# The f90 objects we need
F90_OBJS = ${F90_SRCS:.f90=.o}

# Switches we need for compiling - need +DA1.1 +DS1.1 so code runs on
# different hp processors
#F90OPS = +z -c +DA1.1 +DS1.1 

ifeq ($(FC),lf95)
  FCOMPILER = /usr/local/lf9562/bin/lf95
  F90OPS = -c
else
  ifeq ($(FC),mpilf95)
    FCOMPILER =/c/source/mpich_lf95/bin/mpif90
    F90OPS = -c
  else
#    FCOMPILER = /c/source/PGI/pgi/linux86/7.2-2/bin/pgf90
#    FCOMPILER = /c/source/PGI/pgi/linux86/8.0-2/bin/pgf90
#    FCOMPILER = /c/source/PGI/pgi/linux86/9.0-3/bin/pgf90
#    FCOMPILER = /c/source/PGI/pgi/linux86/10.8/bin/pgf90
#    FCOMPILER = /opt/pgi/linux86-64/14.6/bin/pgf90
#               venus defaults to 13.2
    FCOMPILER = pgf90
# 20140825 tbt Added -g -Msave (to zero out variables)
    F90OPS = -g -Msave -c -Mbackslash -Ktrap=divz
  endif
endif
ifeq ($(FC),mpipgf90)
    #FCOMPILER = /c/source/PGI/pgi/linux86/9.0/mpi/mpich/bin/mpif90
#   FCOMPILER = /task/imd/apps/mpi/mpich2/pgi/32/bin/mpif90
    FCOMPILER = mpif90
    F90OPS = -c -Msave -Mbackslash -I$(MPICH_DIR)/include
    MDSLIBS=$(MDSPLUS)/lib64/libMdsLib_client.a $(MDSPLUS)/lib64/libMdsIpShr.a $(MDSPLUS)/lib64/libMdsShr.a
    MPILIBS=-L$(MPICH_DIR)/lib -lmpichf90 -lmpich -lfmpich -lmpl -lopa
	 # LLIBS is defined in defaults-paths module
    DLIBS=$(LLIBS)
endif
#-I/u/groebner/cer/cerlib/mds/

# Make the shareable library
mds_rg.so:	$(F90_OBJS)
	echo " "
	echo " 20140825 tbt In directory "
	pwd
	echo " 20140825 tbt Now using $(MDSPLUS)/lib64/libMdsLib_client.a "
	echo " "
#       Added 64 below
#	ld -o mds_rg.so $(F90_OBJS) /f/mdsplus/linux/lib/libMdsLib_client.a
	ld -o mds_rg.so $(F90_OBJS) $(DLIBS) $(MPILIBS) $(MDSLIBS)

#		-L/f/mdsplus/hp/shlib/ -lMdsLib         \
#		-L/f/mdsplus/hp/shlib/ -lTdiShr   
#        \
#                -L/f/mdsplus/hp/shlib/ -lTdiShr-lTdiShr
     
mdslib.o: mdslib.f90
	$(FCOMPILER) $(F90OPS) mdslib.f90

mds_mtanh_rdts.o:	mds_mtanh_rdts.f90
	$(FCOMPILER) $(F90OPS) mds_mtanh_rdts.f90

mds_mtanh.o:	mds_mtanh.f90
	$(FCOMPILER) $(F90OPS) mds_mtanh.f90

mds_rg.o: mdslib.f90 mds_rg.f90
	$(FCOMPILER) $(F90OPS) mds_rg.f90

mds_write_rg.o:	mds_write_rg.f90
	$(FCOMPILER) $(F90OPS) mds_write_rg.f90

mds_rg.a: mdslib.o mds_rg.o mds_mtanh.o mds_mtanh_rdts.o 
	ar r mds_rg.a mds_rg.o mds_mtanh.o mds_mtanh_rdts.o
	ranlib mds_rg.a
clean:
	@rm -f *.o *.mod *.a
#
#
