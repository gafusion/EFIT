#!/bin/bash

export link_efit="@CURRENT_MACHINE_LINK_DIR@"
export link_store=""

# Sanity checks
if ! test -e ${link_efit}/green/dprobe.dat; then
  echo "not running test because Greens tables were not found"
  exit 1
fi
if ! test -e ${link_efit}/lim.dat; then
  echo "not running test because limiter was not found"
  exit 1
fi

# Remove any previous outputs
rm -r std_out

# Move outputs from non-HDF5 test to subdirectory
mkdir std_out
if [ @HAVE_NETCDF@ = True ]; then
  outputs=( a g m )
else
  outputs=( a g )
fi
mv run_efit.out std_out
for prefix in ${outputs[*]}; do
  for label in @EFIT_LABEL@; do
    mv ${prefix}${label} std_out
  done
done

# Now run efit
@EFIT_EXEC@ @GRID_SIZE@ << __c__MATCHING_EOF__c__ > run_efit.out

@EFIT_MODE@
@EFIT_IN@

__c__MATCHING_EOF__c__

# Pass the results of the efit command up so that CTest knows what happened
exit $result
